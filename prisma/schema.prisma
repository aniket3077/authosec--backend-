generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model approvals {
  id                                  String         @id
  company_id                          String
  type                                ApprovalType
  title                               String
  description                         String?
  requested_by                        String
  approved_by                         String?
  status                              ApprovalStatus @default(PENDING)
  priority                            Priority       @default(MEDIUM)
  amount                              Decimal?       @db.Decimal(15, 2)
  metadata                            Json           @default("{}")
  requested_at                        DateTime       @default(now())
  reviewed_at                         DateTime?
  rejected_reason                     String?
  created_at                          DateTime       @default(now())
  updated_at                          DateTime
  users_approvals_approved_byTousers  users?         @relation("approvals_approved_byTousers", fields: [approved_by], references: [id], onDelete: NoAction)
  users_approvals_requested_byTousers users          @relation("approvals_requested_byTousers", fields: [requested_by], references: [id], onDelete: NoAction)

  @@index([company_id])
  @@index([requested_by])
  @@index([status])
  @@index([type])
}

model audit_logs {
  id          String     @id
  user_id     String?
  company_id  String?
  action      String
  resource    String
  resource_id String?
  old_values  Json?
  new_values  Json?
  ip_address  String?
  user_agent  String?
  created_at  DateTime   @default(now())
  companies   companies? @relation(fields: [company_id], references: [id])
  users       users?     @relation(fields: [user_id], references: [id])

  @@index([company_id])
  @@index([created_at])
  @@index([resource])
  @@index([user_id])
}

model companies {
  id                      String           @id
  clerk_org_id            String?
  name                    String
  email                   String           @unique
  phone                   String
  business_type           String
  registration_id         String           @unique
  address                 String?
  subscription_tier       SubscriptionTier @default(FREE)
  subscription_expires_at DateTime?
  is_active               Boolean          @default(true)
  settings                Json             @default("{}")
  created_at              DateTime         @default(now())
  updated_at              DateTime
  firebase_org_id         String?          @unique @db.VarChar(255)
  audit_logs              audit_logs[]
  notifications           notifications[]
  transactions            transactions[]
  users                   users[]

  @@index([email])
  @@index([registration_id])
  @@index([subscription_tier])
}

model custom_roles {
  id               String             @id
  company_id       String
  name             String
  description      String?
  permissions      Json               @default("[]")
  is_active        Boolean            @default(true)
  created_at       DateTime           @default(now())
  updated_at       DateTime
  role_assignments role_assignments[]

  @@unique([company_id, name])
  @@index([company_id])
}

model employee_metrics {
  id              String    @id
  user_id         String
  date            DateTime  @default(now())
  productivity    Decimal   @default(0) @db.Decimal(5, 2)
  tasks_completed Int       @default(0)
  tasks_assigned  Int       @default(0)
  hours_worked    Decimal   @default(0) @db.Decimal(5, 2)
  login_time      DateTime?
  logout_time     DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime
  users           users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([user_id])
}

model merchants {
  id                                    String         @id
  company_id                            String
  name                                  String
  business_name                         String
  email                                 String
  phone                                 String
  category                              String
  address                               String?
  status                                MerchantStatus @default(PENDING)
  registration_id                       String?
  gst_number                            String?
  bank_account                          String?
  ifsc_code                             String?
  documents                             Json           @default("{}")
  created_by_id                         String
  approved_by_id                        String?
  approved_at                           DateTime?
  rejected_reason                       String?
  created_at                            DateTime       @default(now())
  updated_at                            DateTime
  users_merchants_approved_by_idTousers users?         @relation("merchants_approved_by_idTousers", fields: [approved_by_id], references: [id], onDelete: NoAction)
  users_merchants_created_by_idTousers  users          @relation("merchants_created_by_idTousers", fields: [created_by_id], references: [id], onDelete: NoAction)

  @@index([company_id])
  @@index([created_by_id])
  @@index([status])
}

model notifications {
  id         String               @id
  user_id    String
  company_id String?
  title      String
  message    String
  is_read    Boolean              @default(false)
  read_at    DateTime?
  action_url String?
  metadata   Json                 @default("{}")
  created_at DateTime             @default(now())
  type       NotificationType
  priority   NotificationPriority @default(NORMAL)
  companies  companies?           @relation(fields: [company_id], references: [id], onDelete: Cascade)
  users      users                @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([company_id])
  @@index([created_at])
  @@index([is_read])
  @@index([user_id])
}

model otp_logs {
  id             String        @id
  user_id        String?
  phone_number   String
  otp_hash       String
  purpose        String
  transaction_id String?
  is_verified    Boolean       @default(false)
  verified_at    DateTime?
  attempts       Int           @default(0)
  expires_at     DateTime
  ip_address     String?
  user_agent     String?
  created_at     DateTime      @default(now())
  transactions   transactions? @relation(fields: [transaction_id], references: [id])
  users          users?        @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([expires_at])
  @@index([phone_number])
  @@index([purpose])
  @@index([transaction_id])
  @@index([user_id])
}

model project_tasks {
  id           String     @id
  project_id   String
  title        String
  description  String?
  status       TaskStatus @default(TODO)
  priority     Priority   @default(MEDIUM)
  assigned_to  String?
  due_date     DateTime?
  completed_at DateTime?
  created_at   DateTime   @default(now())
  updated_at   DateTime
  users        users?     @relation(fields: [assigned_to], references: [id], onDelete: NoAction)
  projects     projects   @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@index([assigned_to])
  @@index([project_id])
  @@index([status])
}

model projects {
  id                                  String          @id
  company_id                          String
  name                                String
  description                         String?
  status                              ProjectStatus   @default(PLANNING)
  budget                              Decimal?        @db.Decimal(15, 2)
  spent                               Decimal         @default(0) @db.Decimal(15, 2)
  start_date                          DateTime?
  end_date                            DateTime?
  progress                            Int             @default(0)
  priority                            Priority        @default(MEDIUM)
  created_by_id                       String
  owner_id                            String
  created_at                          DateTime        @default(now())
  updated_at                          DateTime
  project_tasks                       project_tasks[]
  users_projects_created_by_idTousers users           @relation("projects_created_by_idTousers", fields: [created_by_id], references: [id], onDelete: NoAction)
  users_projects_owner_idTousers      users           @relation("projects_owner_idTousers", fields: [owner_id], references: [id], onDelete: NoAction)

  @@index([company_id])
  @@index([owner_id])
  @@index([status])
}

model qr_scan_logs {
  id             String   @id
  transaction_id String?
  company_id     String?
  qr_type        String
  scanned_at     DateTime @default(now())
  ip_address     String?
  user_agent     String?
  location       Json?
  metadata       Json     @default("{}")
  created_at     DateTime @default(now())

  @@index([company_id])
  @@index([scanned_at])
  @@index([transaction_id])
}

model role_assignments {
  id           String       @id
  user_id      String
  role_id      String
  assigned_at  DateTime     @default(now())
  expires_at   DateTime?
  created_at   DateTime     @default(now())
  custom_roles custom_roles @relation(fields: [role_id], references: [id], onDelete: Cascade)
  users        users        @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, role_id])
  @@index([role_id])
  @@index([user_id])
}

model transaction_logs {
  id             String       @id
  transaction_id String
  action         String
  status         String?
  metadata       Json         @default("{}")
  ip_address     String?
  user_agent     String?
  created_at     DateTime     @default(now())
  transactions   transactions @relation(fields: [transaction_id], references: [id], onDelete: Cascade)

  @@index([created_at])
  @@index([transaction_id])
}

model transactions {
  id                                    String             @id
  transaction_number                    String             @unique
  sender_id                             String
  company_id                            String?
  receiver_id                           String
  amount                                Decimal?           @db.Decimal(15, 2)
  currency                              String             @default("INR")
  description                           String?
  metadata                              Json               @default("{}")
  status                                TransactionStatus  @default(INITIATED)
  qr1_code                              String?
  qr1_encrypted_data                    String?
  qr1_generated_at                      DateTime?
  qr1_expires_at                        DateTime?
  qr2_code                              String?
  qr2_encrypted_data                    String?
  qr2_generated_at                      DateTime?
  qr2_expires_at                        DateTime?
  otp_hash                              String?
  otp_sent_at                           DateTime?
  otp_verified_at                       DateTime?
  otp_attempts                          Int                @default(0)
  encryption_key                        String?
  iv                                    String?
  initiated_at                          DateTime           @default(now())
  completed_at                          DateTime?
  failed_at                             DateTime?
  expires_at                            DateTime?
  created_at                            DateTime           @default(now())
  updated_at                            DateTime
  otp_logs                              otp_logs[]
  transaction_logs                      transaction_logs[]
  companies                             companies?         @relation(fields: [company_id], references: [id])
  users_transactions_receiver_idTousers users              @relation("transactions_receiver_idTousers", fields: [receiver_id], references: [id], onDelete: Cascade)
  users_transactions_sender_idTousers   users              @relation("transactions_sender_idTousers", fields: [sender_id], references: [id], onDelete: Cascade)

  @@index([company_id])
  @@index([created_at])
  @@index([receiver_id])
  @@index([sender_id])
  @@index([status])
  @@index([transaction_number])
}

model users {
  id                                           String             @id
  email                                        String?
  clerk_id                                     String?
  company_id                                   String?
  created_at                                   DateTime           @default(now())
  first_name                                   String?
  image_url                                    String?
  is_active                                    Boolean            @default(true)
  last_login                                   DateTime?
  last_name                                    String?
  phone                                        String?            @unique
  role                                         UserRole           @default(ACCOUNT_USER)
  updated_at                                   DateTime
  firebase_uid                                 String?            @unique @db.VarChar(255)
  department                                   String?
  position                                     String?
  approvals_approvals_approved_byTousers       approvals[]        @relation("approvals_approved_byTousers")
  approvals_approvals_requested_byTousers      approvals[]        @relation("approvals_requested_byTousers")
  audit_logs                                   audit_logs[]
  employee_metrics                             employee_metrics[]
  merchants_merchants_approved_by_idTousers    merchants[]        @relation("merchants_approved_by_idTousers")
  merchants_merchants_created_by_idTousers     merchants[]        @relation("merchants_created_by_idTousers")
  notifications                                notifications[]
  otp_logs                                     otp_logs[]
  project_tasks                                project_tasks[]
  projects_projects_created_by_idTousers       projects[]         @relation("projects_created_by_idTousers")
  projects_projects_owner_idTousers            projects[]         @relation("projects_owner_idTousers")
  role_assignments                             role_assignments[]
  transactions_transactions_receiver_idTousers transactions[]     @relation("transactions_receiver_idTousers")
  transactions_transactions_sender_idTousers   transactions[]     @relation("transactions_sender_idTousers")
  companies                                    companies?         @relation(fields: [company_id], references: [id])

  @@index([company_id])
  @@index([department])
  @@index([firebase_uid])
  @@index([phone])
  @@index([role])
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ApprovalType {
  EXPENSE
  MERCHANT
  PROJECT
  ROLE_CHANGE
  SETTING_CHANGE
  OTHER
}

enum MerchantStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationType {
  TRANSACTION
  SECURITY
  SYSTEM
  ALERT
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  COMPLETED
  CANCELLED
}

enum TransactionStatus {
  INITIATED
  QR1_SCANNED
  QR2_GENERATED
  QR2_SCANNED
  OTP_SENT
  OTP_VERIFIED
  COMPLETED
  FAILED
  CANCELLED
}

enum UserRole {
  SUPER_ADMIN
  COMPANY_ADMIN
  ACCOUNT_USER
}
