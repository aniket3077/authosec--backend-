generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                   String         @id @default(uuid())
  email                String?
  clerkId              String         @unique @map("clerk_id")
  companyId            String?        @map("company_id")
  createdAt            DateTime       @default(now()) @map("created_at")
  firstName            String?        @map("first_name")
  imageUrl             String?        @map("image_url")
  isActive             Boolean        @default(true) @map("is_active")
  lastLogin            DateTime?      @map("last_login")
  lastName             String?        @map("last_name")
  phone                String?        @unique
  role                 UserRole       @default(ACCOUNT_USER)
  updatedAt            DateTime       @updatedAt @map("updated_at")
  auditLogs            AuditLog[]
  notifications        Notification[]
  otpLogs              OtpLog[]
  receivedTransactions Transaction[]  @relation("ReceiverTransactions")
  sentTransactions     Transaction[]  @relation("SenderTransactions")
  company              Company?       @relation(fields: [companyId], references: [id])

  @@index([clerkId])
  @@index([phone])
  @@index([companyId])
  @@index([role])
  @@map("users")
}

model Company {
  id                    String           @id @default(uuid())
  clerkOrgId            String?          @unique @map("clerk_org_id")
  name                  String
  email                 String           @unique
  phone                 String
  businessType          String           @map("business_type")
  registrationId        String           @unique @map("registration_id")
  address               String?
  subscriptionTier      SubscriptionTier @default(FREE) @map("subscription_tier")
  subscriptionExpiresAt DateTime?        @map("subscription_expires_at")
  isActive              Boolean          @default(true) @map("is_active")
  settings              Json             @default("{}")
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")
  auditLogs             AuditLog[]
  notifications         Notification[]
  transactions          Transaction[]
  users                 User[]

  @@index([email])
  @@index([registrationId])
  @@index([subscriptionTier])
  @@map("companies")
}

model Transaction {
  id                String            @id @default(uuid())
  transactionNumber String            @unique @map("transaction_number")
  senderId          String            @map("sender_id")
  companyId         String?           @map("company_id")
  receiverId        String            @map("receiver_id")
  amount            Decimal?          @db.Decimal(15, 2)
  currency          String            @default("INR")
  description       String?
  metadata          Json              @default("{}")
  status            TransactionStatus @default(INITIATED)
  qr1Code           String?           @map("qr1_code")
  qr1EncryptedData  String?           @map("qr1_encrypted_data")
  qr1GeneratedAt    DateTime?         @map("qr1_generated_at")
  qr1ExpiresAt      DateTime?         @map("qr1_expires_at")
  qr2Code           String?           @map("qr2_code")
  qr2EncryptedData  String?           @map("qr2_encrypted_data")
  qr2GeneratedAt    DateTime?         @map("qr2_generated_at")
  qr2ExpiresAt      DateTime?         @map("qr2_expires_at")
  otpHash           String?           @map("otp_hash")
  otpSentAt         DateTime?         @map("otp_sent_at")
  otpVerifiedAt     DateTime?         @map("otp_verified_at")
  otpAttempts       Int               @default(0) @map("otp_attempts")
  encryptionKey     String?           @map("encryption_key")
  iv                String?
  initiatedAt       DateTime          @default(now()) @map("initiated_at")
  completedAt       DateTime?         @map("completed_at")
  failedAt          DateTime?         @map("failed_at")
  expiresAt         DateTime?         @map("expires_at")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  otpLogs           OtpLog[]
  logs              TransactionLog[]
  company           Company?          @relation(fields: [companyId], references: [id])
  receiver          User              @relation("ReceiverTransactions", fields: [receiverId], references: [id], onDelete: Cascade)
  sender            User              @relation("SenderTransactions", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([transactionNumber])
  @@index([senderId])
  @@index([receiverId])
  @@index([companyId])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

model TransactionLog {
  id            String      @id @default(uuid())
  transactionId String      @map("transaction_id")
  action        String
  status        String?
  metadata      Json        @default("{}")
  ipAddress     String?     @map("ip_address")
  userAgent     String?     @map("user_agent")
  createdAt     DateTime    @default(now()) @map("created_at")
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@index([createdAt])
  @@map("transaction_logs")
}

model OtpLog {
  id            String       @id @default(uuid())
  userId        String?      @map("user_id")
  phone         String       @map("phone_number")
  otpHash       String       @map("otp_hash")
  purpose       String
  transactionId String?      @map("transaction_id")
  isVerified    Boolean      @default(false) @map("is_verified")
  verifiedAt    DateTime?    @map("verified_at")
  attempts      Int          @default(0)
  expiresAt     DateTime     @map("expires_at")
  ipAddress     String?      @map("ip_address")
  userAgent     String?      @map("user_agent")
  createdAt     DateTime     @default(now()) @map("created_at")
  transaction   Transaction? @relation(fields: [transactionId], references: [id])
  user          User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([phone])
  @@index([transactionId])
  @@index([purpose])
  @@index([expiresAt])
  @@map("otp_logs")
}

model Notification {
  id        String               @id @default(uuid())
  userId    String               @map("user_id")
  companyId String?              @map("company_id")
  title     String
  message   String
  type      NotificationType
  priority  NotificationPriority @default(NORMAL)
  isRead    Boolean              @default(false) @map("is_read")
  readAt    DateTime?            @map("read_at")
  actionUrl String?              @map("action_url")
  metadata  Json                 @default("{}")
  createdAt DateTime             @default(now()) @map("created_at")
  company   Company?             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([companyId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  companyId  String?  @map("company_id")
  action     String
  resource   String
  resourceId String?  @map("resource_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")
  company    Company? @relation(fields: [companyId], references: [id])
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([companyId])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

enum UserRole {
  SUPER_ADMIN
  COMPANY_ADMIN
  ACCOUNT_USER
}

enum TransactionStatus {
  INITIATED
  QR1_SCANNED
  QR2_GENERATED
  QR2_SCANNED
  OTP_SENT
  OTP_VERIFIED
  COMPLETED
  FAILED
  CANCELLED
}

enum NotificationType {
  TRANSACTION
  SECURITY
  SYSTEM
  ALERT
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}
